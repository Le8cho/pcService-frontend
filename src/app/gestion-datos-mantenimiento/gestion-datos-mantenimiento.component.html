<!-- gestion-datos-mantenimiento.component.html -->
<div class="grid">
    <div class="col-12">
        <div class="card px-6 py-6">
            <p-toast></p-toast>
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <h2 class="m-0">Gestión de Mantenimiento de Computadoras</h2>
                </ng-template>
                <ng-template pTemplate="right">
                    <button 
                        pButton 
                        pRipple 
                        label="NUEVO" 
                        icon="pi pi-plus" 
                        class="p-button-success mr-2" 
                        (click)="openNew()">
                    </button>
                </ng-template>
            </p-toolbar>

            <!-- Búsqueda -->
            <div class="mb-4">
                <div class="p-inputgroup">
                    <input 
                        type="text" 
                        pInputText 
                        placeholder="Buscar por ID, cliente o equipo..." 
                        [(ngModel)]="searchTerm"
                        (keyup.enter)="searchMantenimientos()"
                        style="width: 300px;">
                    <button 
                        pButton 
                        pRipple 
                        type="button" 
                        icon="pi pi-search" 
                        class="p-button-primary"
                        label="BUSCAR"
                        (click)="searchMantenimientos()">
                    </button>
                    <button 
                        pButton 
                        pRipple 
                        type="button" 
                        icon="pi pi-times" 
                        class="p-button-secondary"
                        (click)="clearSearch()"
                        *ngIf="searchTerm">
                    </button>
                </div>
            </div>

            <!-- Tabla de Mantenimientos -->
            <p-table 
                #dt 
                [value]="mantenimientos" 
                [rows]="10" 
                [paginator]="true"
                [globalFilterFields]="['mantPrev','cod_cliente','nombre_cliente','equipos','frecuencia']"
                [loading]="loading"
                responsiveLayout="scroll">
                
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="mantPrev">
                            #MantPrev 
                            <p-sortIcon field="mantPrev"></p-sortIcon>
                        </th>
                        <th pSortableColumn="cod_cliente">
                            Cod_Cliente 
                            <p-sortIcon field="cod_cliente"></p-sortIcon>
                        </th>
                        <th pSortableColumn="fecha">
                            Fecha Mantenimiento 
                            <p-sortIcon field="fecha"></p-sortIcon>
                        </th>
                        <th pSortableColumn="equipos">
                            Equipos 
                            <p-sortIcon field="equipos"></p-sortIcon>
                        </th>
                        <th pSortableColumn="ingreso">
                            Ingreso 
                            <p-sortIcon field="ingreso"></p-sortIcon>
                        </th>
                        <th pSortableColumn="egreso">
                            Egreso 
                            <p-sortIcon field="egreso"></p-sortIcon>
                        </th>
                        <th pSortableColumn="frecuencia">
                            Frecuencia 
                            <p-sortIcon field="frecuencia"></p-sortIcon>
                        </th>
                        <th pSortableColumn="prox_mantenimiento">
                            Próxima Fecha 
                            <p-sortIcon field="prox_mantenimiento"></p-sortIcon>
                        </th>
                        <th>Acciones</th>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="body" let-mantenimiento>
                    <tr>
                        <td>
                            <span class="p-column-title">#MantPrev</span>
                            {{mantenimiento.mantPrev}}
                        </td>
                        <td>
                            <span class="p-column-title">Cod_Cliente</span>
                            {{mantenimiento.cod_cliente}}
                        </td>
                        <td>
                            <span class="p-column-title">Fecha Mantenimiento</span>
                            {{mantenimiento.fecha | date:'dd/MM/yyyy'}}
                        </td>
                        <td>
                            <span class="p-column-title">Equipos</span>
                            {{mantenimiento.equipos}}
                        </td>
                        <td>
                            <span class="p-column-title">Ingreso</span>
                            {{mantenimiento.ingreso | date:'dd/MM/yyyy'}}
                        </td>
                        <td>
                            <span class="p-column-title">Egreso</span>
                            {{mantenimiento.egreso | date:'dd/MM/yyyy'}}
                        </td>
                        <td>
                            <span class="p-column-title">Frecuencia</span>
                            {{mantenimiento.frecuencia}}
                        </td>
                        <td>
                            <span class="p-column-title">Próxima Fecha</span>
                            {{mantenimiento.prox_mantenimiento | date:'dd/MM/yyyy'}}
                        </td>
                        <td>
                            <div class="flex">
                                <button 
                                    pButton 
                                    pRipple 
                                    icon="pi pi-pencil" 
                                    class="p-button-rounded p-button-success mr-2" 
                                    (click)="editMantenimiento(mantenimiento)"
                                    pTooltip="Editar">
                                </button>
                                <button 
                                    pButton 
                                    pRipple 
                                    icon="pi pi-trash" 
                                    class="p-button-rounded p-button-warning" 
                                    (click)="deleteMantenimiento(mantenimiento)"
                                    pTooltip="Eliminar">
                                </button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>

            <!-- Dialog para Nuevo/Editar Mantenimiento -->
            <p-dialog 
                [(visible)]="mantenimientoDialog" 
                [header]="editMode ? 'Editar Mantenimiento' : 'Nuevo Mantenimiento'"
                [modal]="true" 
                class="p-fluid" 
                [style]="{width: '600px'}"
                [closable]="true">
                
                <ng-template pTemplate="content">
                    <div class="field">
                        <label for="mantPrev">#MantPrev *</label>
                        <input 
                            type="text" 
                            pInputText 
                            id="mantPrev" 
                            [(ngModel)]="mantenimientoForm.mantPrev" 
                            required 
                            autofocus 
                            [ngClass]="{'ng-invalid ng-dirty' : !mantenimientoForm.mantPrev}">
                        <small class="ng-dirty ng-invalid" *ngIf="!mantenimientoForm.mantPrev">
                            #MantPrev es requerido.
                        </small>
                    </div>

                    <div class="field">
                        <label for="codCliente">Cod_Cliente *</label>
                        <input 
                            type="text" 
                            pInputText 
                            id="codCliente" 
                            [(ngModel)]="mantenimientoForm.cod_cliente" 
                            required
                            [ngClass]="{'ng-invalid ng-dirty' : !mantenimientoForm.cod_cliente}">
                        <small class="ng-dirty ng-invalid" *ngIf="!mantenimientoForm.cod_cliente">
                            Código de cliente es requerido.
                        </small>
                    </div>

                    <div class="formgrid grid">
                        <div class="field col">
                            <label for="fechaMantenimiento">Fecha Mantenimiento *</label>
                            <p-calendar 
                                id="fechaMantenimiento"
                                [(ngModel)]="mantenimientoForm.fecha_mantenimiento"
                                dateFormat="dd/mm/yy"
                                [showIcon]="true">
                            </p-calendar>
                        </div>

                        <div class="field col">
                            <label for="equipos">Equipos *</label>
                            <input 
                                type="text" 
                                pInputText 
                                id="equipos" 
                                [(ngModel)]="mantenimientoForm.equipos" 
                                required
                                [ngClass]="{'ng-invalid ng-dirty' : !mantenimientoForm.equipos}">
                        </div>
                    </div>

                    <div class="formgrid grid">
                        <div class="field col">
                            <label for="ingreso">Ingreso</label>
                            <p-calendar 
                                id="ingreso"
                                [(ngModel)]="mantenimientoForm.ingreso"
                                dateFormat="dd/mm/yy"
                                [showIcon]="true">
                            </p-calendar>
                        </div>

                        <div class="field col">
                            <label for="egreso">Egreso</label>
                            <p-calendar 
                                id="egreso"
                                [(ngModel)]="mantenimientoForm.egreso"
                                dateFormat="dd/mm/yy"
                                [showIcon]="true">
                            </p-calendar>
                        </div>
                    </div>

                    <div class="formgrid grid">
                        <div class="field col">
                            <label for="frecuencia">Frecuencia *</label>
                            <p-dropdown 
                                id="frecuencia"
                                [(ngModel)]="mantenimientoForm.frecuencia" 
                                [options]="frecuenciaOptions" 
                                placeholder="Seleccionar frecuencia"
                                [ngClass]="{'ng-invalid ng-dirty' : !mantenimientoForm.frecuencia}">
                            </p-dropdown>
                        </div>

                        <div class="field col">
                            <label for="proxFecha">Próxima Fecha</label>
                            <p-calendar 
                                id="proxFecha"
                                [(ngModel)]="mantenimientoForm.prox_fecha"
                                dateFormat="dd/mm/yy"
                                [showIcon]="true">
                            </p-calendar>
                        </div>
                    </div>
                </ng-template>

                <ng-template pTemplate="footer">
                    <button 
                        pButton 
                        pRipple 
                        label="Cancelar" 
                        icon="pi pi-times" 
                        class="p-button-text" 
                        (click)="hideDialog()">
                    </button>
                    <button 
                        pButton 
                        pRipple 
                        [label]="editMode ? 'Guardar Cambios' : 'Guardar'" 
                        icon="pi pi-check" 
                        class="p-button-text" 
                        (click)="saveMantenimiento()">
                    </button>
                </ng-template>
            </p-dialog>

            <p-confirmDialog [style]="{width: '425px'}"></p-confirmDialog>
        </div>
    </div>
</div>